#!/bin/bash
# Git Pre-commit Hook: 문서 의존성 체크 (토큰 최적화 버전)
# 환경변수 DOC_HOOK_VERBOSE=1 로 상세 모드 활성화

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# 상세 모드 (기본: 요약)
VERBOSE=${DOC_HOOK_VERBOSE:-0}

# 파일 경로
DEPENDENCY_MAP=".claude/docs/dependency-map.md"
DOCS_MAPPING=".claude/agents/docs-mapping.md"
CHANGELOG="01. docs/changelog.md"

# 파일 목록
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$')
NEW_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.md$')
DELETED_MD_FILES=$(git diff --cached --name-only --diff-filter=D | grep '\.md$')

# 카운터
NEW_COUNT=0
DELETED_COUNT=0
UNREGISTERED_COUNT=0
MISSING_RELATED_COUNT=0

# .md 파일이 없으면 종료
if [ -z "$STAGED_FILES" ] && [ -z "$DELETED_MD_FILES" ]; then
    exit 0
fi

# 의존성 맵 체크
if [ ! -f "$DEPENDENCY_MAP" ]; then
    echo -e "${YELLOW}[!] dependency-map.md 없음${NC}"
    exit 0
fi

# 연관 문서 찾기 함수
find_related_docs() {
    local basename=$(basename "$1")
    grep "| \`$basename\`" "$DEPENDENCY_MAP" 2>/dev/null | awk -F'|' '{print $3}' | tr ',' '\n' | sed 's/^ *//;s/ *$//' | grep -v '^$'
}

echo -e "${CYAN}[문서 체크]${NC}"

# === 새 문서 체크 ===
if [ -n "$NEW_MD_FILES" ]; then
    echo "$NEW_MD_FILES" | while IFS= read -r file; do
        [ -z "$file" ] && continue
        file_basename=$(basename "$file")
        [[ "$file_basename" =~ ^(changelog|dependency-map|docs-mapping)\.md$ ]] && continue

        if ! grep -q "\`$file_basename\`" "$DEPENDENCY_MAP" 2>/dev/null; then
            echo -e "  ${YELLOW}+${NC} $file_basename ${YELLOW}(미등록)${NC}"
            touch /tmp/doc_unregistered_flag
        elif [ "$VERBOSE" = "1" ]; then
            echo -e "  ${GREEN}+${NC} $file_basename"
        fi
    done
fi

# === 삭제 문서 체크 ===
if [ -n "$DELETED_MD_FILES" ]; then
    echo "$DELETED_MD_FILES" | while IFS= read -r file; do
        [ -z "$file" ] && continue
        file_basename=$(basename "$file")

        needs_cleanup=false
        grep -q "\`$file_basename\`" "$DEPENDENCY_MAP" 2>/dev/null && needs_cleanup=true
        [ -f "$DOCS_MAPPING" ] && grep -q "$file_basename" "$DOCS_MAPPING" 2>/dev/null && needs_cleanup=true

        if [ "$needs_cleanup" = true ]; then
            echo -e "  ${RED}-${NC} $file_basename ${YELLOW}(정리 필요)${NC}"
            touch /tmp/doc_deleted_flag
        elif [ "$VERBOSE" = "1" ]; then
            echo -e "  ${RED}-${NC} $file_basename"
        fi
    done
fi

# === 연관 문서 체크 ===
MISSING_LIST=""
for file in $STAGED_FILES; do
    basename=$(basename "$file")
    [[ "$basename" =~ ^(changelog|dependency-map)\.md$ ]] && continue

    RELATED=$(find_related_docs "$file")
    [ -z "$RELATED" ] && continue

    while IFS= read -r related; do
        related=$(echo "$related" | xargs)
        [ -z "$related" ] && continue

        if ! echo "$STAGED_FILES" | grep -q "$related"; then
            MISSING_LIST="$MISSING_LIST$related "
            touch /tmp/doc_missing_flag
        fi
    done <<< "$RELATED"
done

# === 결과 출력 ===
ISSUES=0

if [ -f /tmp/doc_unregistered_flag ]; then
    ISSUES=$((ISSUES + 1))
    rm -f /tmp/doc_unregistered_flag
fi

if [ -f /tmp/doc_deleted_flag ]; then
    ISSUES=$((ISSUES + 1))
    rm -f /tmp/doc_deleted_flag
fi

if [ -f /tmp/doc_missing_flag ]; then
    ISSUES=$((ISSUES + 1))
    rm -f /tmp/doc_missing_flag
    if [ -n "$MISSING_LIST" ] && [ "$VERBOSE" = "1" ]; then
        echo -e "  ${YELLOW}연관:${NC} $MISSING_LIST"
    fi
fi

# changelog 체크
if ! echo "$STAGED_FILES" | grep -q "changelog.md"; then
    ISSUES=$((ISSUES + 1))
fi

# 최종 결과
if [ $ISSUES -gt 0 ]; then
    echo -e "${YELLOW}→ $ISSUES개 항목 확인 필요${NC}"
    [ "$VERBOSE" != "1" ] && echo -e "  ${CYAN}상세: DOC_HOOK_VERBOSE=1 git commit${NC}"
else
    echo -e "${GREEN}→ OK${NC}"
fi

exit 0
